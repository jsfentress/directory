---
import { createClient } from '@supabase/supabase-js';
const { slug } = Astro.params;
const supabase = createClient(import.meta.env.SUPABASE_URL, import.meta.env.SUPABASE_ANON_KEY);

const { data: event, error } = await supabase
  .from('events')
  .select('*')
  .eq('slug', slug)
  .single();

if (error || !event) {
  throw new Error('Event not found');
}

const metaTitle = `${event.title} at ${event.venue} – ${event.date} | Nashville Setlist`;
const metaDescription = event.description?.slice(0, 160) || 'Live music event in Nashville.';
const eventDateISO = event.date ? `${event.date}T19:00:00-05:00` : '';
const jsonLd = {
  '@context': 'https://schema.org',
  '@type': 'Event',
  name: event.title,
  startDate: eventDateISO,
  location: {
    '@type': 'Place',
    name: event.venue,
    address: 'Nashville, TN',
  },
  description: event.description,
  eventStatus: 'https://schema.org/EventScheduled',
  eventAttendanceMode: 'https://schema.org/OfflineEventAttendanceMode',
  offers: {
    '@type': 'Offer',
    price: event.price,
    priceCurrency: 'USD',
    availability: 'https://schema.org/InStock',
  },
};
---
<html lang="en">
  <head>
    <title>{metaTitle}</title>
    <meta name="description" content={metaDescription} />
    <script type="application/ld+json">{JSON.stringify(jsonLd)}</script>
  </head>
  <body>
    <main class="max-w-2xl mx-auto p-6">
      <h1 class="text-3xl font-bold mb-2">{event.title}</h1>
      <div class="mb-2 text-lg">at <a href={"/venues/" + event.venue?.toLowerCase().replace(/\s+/g, '-')}>{event.venue}</a></div>
      <div class="mb-2 text-gray-600">{event.date}</div>
      <div class="mb-4">{event.description}</div>
      <div class="mb-4">
        <span class="font-semibold">Genres:</span>
        {(event.genre || []).map(g => (
          <a href={`/events?vibe=${encodeURIComponent(g)}`} class="ml-2 underline">{g}</a>
        ))}
      </div>
      {event.editor_pick && (
        <div class="mb-4">
          <a href="/events?editor_pick=true" class="bg-indigo-600 text-white px-3 py-1 rounded-full font-semibold">Editor's Pick</a>
        </div>
      )}
      <div class="mb-6 flex gap-4">
        <button class="bg-green-600 text-white px-4 py-2 rounded">RSVP</button>
        <a href="#" class="bg-blue-600 text-white px-4 py-2 rounded">Add to Calendar</a>
      </div>
      <a href="/events" class="underline">← Back to all events</a>
    </main>
  </body>
</html> 